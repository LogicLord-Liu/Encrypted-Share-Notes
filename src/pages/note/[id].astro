---
import Layout from "../../layouts/Layout.astro";

// åœ¨æœåŠ¡å™¨ç«¯è·å–è·¯ç”±å‚æ•°
const { id } = Astro.params;
---

<Layout title="æŸ¥çœ‹ç¬”è®° - Enclosed">
  <main class="flex flex-col items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-2xl text-center">
      <h1 class="text-3xl font-bold mb-6 text-gray-800">ç¬”è®°å†…å®¹</h1>

      <div id="note-display-area">
        <p class="text-gray-600">æ­£åœ¨åŠ è½½ç¬”è®°...</p>
      </div>

      <div id="password-form-container" class="hidden"></div>

      <a href="/" class="mt-8 inline-block text-sky-600 hover:underline"
        >è¿”å›é¦–é¡µ</a
      >
    </div>
  </main>

  <div
    id="custom-alert-modal"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden transition-opacity duration-300"
  >
    <div
      class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300"
    >
      <h3 class="text-2xl font-bold text-red-600 mb-4 text-center">è­¦å‘Š</h3>
      <p id="alert-message" class="text-gray-700 text-center mb-6">
        æ‚¨å·²è¿ç»­è¾“é”™å¯†ç ä¸‰æ¬¡ï¼Œè¯¥ç¬”è®°å·²è¢«æ°¸ä¹…åˆ é™¤ã€‚
      </p>
      <button
        id="alert-close-button"
        class="w-full py-3 rounded-xl bg-red-500 text-white font-medium hover:bg-red-600 transition-colors"
      >
        ç¡®å®š
      </button>
    </div>
  </div>
</Layout>

<script is:inline>
  if (typeof window !== "undefined") {
    const url = new URL(window.location.href);
    const noteId = url.pathname.split("/").pop();
    const noteDisplayArea = document.getElementById("note-display-area");
    const passwordFormContainer = document.getElementById(
      "password-form-container"
    );
    const isProduction = window.location.hostname !== "localhost";
    let deleteTriggered = false;

    // å¯†ç å°è¯•æ¬¡æ•°å˜é‡å’Œä¸Šé™
    let passwordAttempts = 0;
    const MAX_ATTEMPTS = 3;

    // è·å–æ¨¡æ€æ¡†å…ƒç´ 
    const customAlertModal = document.getElementById("custom-alert-modal");
    const alertMessage = document.getElementById("alert-message");
    const alertCloseButton = document.getElementById("alert-close-button");

    /**
     * æ˜¾ç¤ºè‡ªå®šä¹‰è­¦å‘Šæ¨¡æ€æ¡†
     * @param {string} message - è¦æ˜¾ç¤ºçš„æç¤ºä¿¡æ¯
     */
    function showCustomAlert(message) {
      if (!customAlertModal || !alertMessage) return;
      alertMessage.textContent = message;
      customAlertModal.classList.remove("hidden", "opacity-0");
      customAlertModal.classList.add("flex", "opacity-100");
      document.body.style.overflow = "hidden";

      alertCloseButton.addEventListener(
        "click",
        () => {
          hideCustomAlert();
          window.location.href = "/";
        },
        { once: true }
      );
    }

    /**
     * éšè—è‡ªå®šä¹‰è­¦å‘Šæ¨¡æ€æ¡†
     */
    function hideCustomAlert() {
      if (!customAlertModal) return;
      customAlertModal.classList.remove("opacity-100");
      customAlertModal.classList.add("opacity-0");
      setTimeout(() => {
        customAlertModal.classList.add("hidden");
        document.body.style.overflow = "";
      }, 300);
    }

    /**
     * æ˜¾ç¤ºåŠ è½½å¤±è´¥çš„é”™è¯¯ä¿¡æ¯
     * @param {string} message - é”™è¯¯ä¿¡æ¯
     */
    function displayError(message) {
      if (!noteDisplayArea) return;
      noteDisplayArea.innerHTML = `
        <div class="bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-xl shadow-sm animate-fade-in">
          <h3 class="text-lg font-semibold text-center">åŠ è½½ç¬”è®°å¤±è´¥</h3>
          <p class="text-sm text-center mt-2">${message}</p>
        </div>
      `;
    }

    /**
     * å‘æœåŠ¡å™¨å‘é€ DELETE è¯·æ±‚ä»¥åˆ é™¤ç¬”è®°
     * @param {string} id - ç¬”è®°çš„ID
     */
    async function deleteNoteFromServer(id) {
      try {
        const response = await fetch(`/api/note/${id}`, {
          method: "DELETE",
          keepalive: true,
        });
        if (!response.ok) {
          console.error(`æœåŠ¡å™¨åˆ é™¤ç¬”è®° ${id} å¤±è´¥:`, response.statusText);
          throw new Error("æœåŠ¡å™¨åˆ é™¤ç¬”è®°å¤±è´¥");
        }
        console.log(`ç¬”è®° ${id} å·²æˆåŠŸä»æœåŠ¡å™¨åˆ é™¤ã€‚`);
      } catch (error) {
        console.error(`åˆ é™¤ç¬”è®° ${id} æ—¶å‡ºé”™:`, error);
      }
    }

    /**
     * æ¸²æŸ“ç¬”è®°å†…å®¹åˆ°é¡µé¢ä¸Š
     * @param {object} note - ç¬”è®°æ•°æ®å¯¹è±¡
     * @param {string} decryptedContent - è§£å¯†åçš„ç¬”è®°å†…å®¹
     * @param {Array<object>} decryptedFiles - è§£å¯†åçš„é™„ä»¶åˆ—è¡¨
     */
    function renderNoteContent(note, decryptedContent, decryptedFiles = []) {
      if (!noteDisplayArea) return;

      let fileListHtml = "";
      if (note.files && note.files.length > 0) {
        fileListHtml = `
          <div class="mt-6">
            <div class="flex items-center space-x-2 text-gray-700 mb-3">
              <svg class="w-5 h-5 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828L18 9.828a4 4 0 10-5.656-5.656L6.343 9.172a6 6 0 108.485 8.485" />
              </svg>
              <p class="font-semibold text-base">é™„ä»¶ï¼š</p>
            </div>
            <ul class="space-y-2 text-sm text-left">
              ${(isProduction ? note.files : decryptedFiles)
                .map(
                  (file) => `
                    <li>
                      <a href="${isProduction ? `/api/file/${note.id}/${file.fileId}` : file.url}"
                        download="${file.name}"
                        class="flex items-center bg-gray-50 border border-gray-200 px-4 py-2 rounded-md hover:bg-sky-50 transition text-sky-600 hover:text-sky-700">
                        
                        <!-- æ–‡ä»¶å + æ–‡ä»¶å¤§å° -->
                        <div class="flex items-center flex-1 min-w-0">
                          <span class="truncate">${file.name}</span>
                          ${
                            !isProduction
                              ? `<span class="ml-auto pl-4 text-gray-400 text-xs shrink-0">${(file.size / 1024).toFixed(1)} KB</span>`
                              : ""
                          }
                        </div>

                        <svg class="w-4 h-4 ml-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M12 12v6m0 0l3-3m-3 3l-3-3" />
                        </svg>
                      </a>
                    </li>`
                )
                .join("")}
            </ul>
          </div>`;
      }
      noteDisplayArea.innerHTML = `
        <article class="prose lg:prose-lg mx-auto text-left break-all whitespace-pre-wrap">
          <p class="font-medium tracking-wide leading-relaxed text-gray-800">${decryptedContent}</p>
        </article>
        <div class="mt-10 pt-6 border-t border-gray-100 text-sm text-gray-700 space-y-4 font-medium tracking-wide leading-6">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 text-left">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3M16 7V3M4 11h16M5 19h14a2 2 0 0 0 2-2v-6H3v6a2 2 0 0 0 2 2z"/>
              </svg>
              <span class="text-gray-800">åˆ›å»ºæ—¶é—´ï¼š${new Intl.DateTimeFormat(
                "en-US",
                {
                  year: "numeric",
                  month: "short",
                  day: "2-digit",
                  hour: "2-digit",
                  minute: "2-digit",
                  second: "2-digit",
                  hour12: false,
                }
              )
                .format(new Date(note.createdAt))
                .replace(",", "")}</span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span class="text-gray-800">è¿‡æœŸæ—¶é—´ï¼š${formatExpiration(note.expiration)}</span>
            </div>
          </div>
          ${
            note.deleteAfterReading
              ? `<p class="text-red-600 font-semibold text-center tracking-wide">âš ï¸ æ­¤ç¬”è®°å°†åœ¨é¦–æ¬¡é˜…è¯»åè‡ªåŠ¨åˆ é™¤</p>`
              : ""
          }
          ${fileListHtml}
        </div>
      `;
      if (passwordFormContainer) {
        passwordFormContainer.innerHTML = "";
        passwordFormContainer.classList.add("hidden");
      }
    }

    /**
     * è§£å¯†ç¬”è®°é™„ä»¶
     * @param {Array<object>} files - åŠ å¯†çš„é™„ä»¶åˆ—è¡¨
     * @param {CryptoKey} cryptoKey - è§£å¯†å¯†é’¥
     * @param {Uint8Array} ivBuffer - IV
     * @returns {Promise<Array<object>>} - è§£å¯†åçš„é™„ä»¶åˆ—è¡¨
     */
    async function decryptFiles(files, cryptoKey, ivBuffer) {
      return Promise.all(
        files.map(async (file) => {
          try {
            const encryptedContentBuffer = Uint8Array.from(
              atob(file.data),
              (c) => c.charCodeAt(0)
            );
            const decryptedContent = await window.crypto.subtle.decrypt(
              { name: "AES-GCM", iv: ivBuffer },
              cryptoKey,
              encryptedContentBuffer
            );
            const blob = new Blob([decryptedContent], { type: file.type });
            const url = URL.createObjectURL(blob);
            return {
              name: file.name,
              size: file.size,
              type: file.type,
              url: url,
            };
          } catch (err) {
            console.error(`æ–‡ä»¶ ${file.name} è§£å¯†å¤±è´¥:`, err);
            return {
              name: `æ–‡ä»¶ ${file.name} (è§£å¯†å¤±è´¥)`,
              size: 0,
              type: "text/plain",
              url: "#",
            };
          }
        })
      );
    }

    /**
     * è§£å¯†ç¬”è®°å†…å®¹å’Œå¯†é’¥
     * @param {object} note - ç¬”è®°æ•°æ®å¯¹è±¡
     * @returns {Promise<object>} - åŒ…å«è§£å¯†å†…å®¹ã€å¯†é’¥å’ŒIVçš„å¯¹è±¡
     */
    async function decryptNote(note) {
      if (!note.key || !note.iv || !note.content) {
        throw new Error("ç¬”è®°æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•è§£å¯†ã€‚");
      }
      const keyBuffer = Uint8Array.from(atob(note.key), (c) => c.charCodeAt(0));
      const ivBuffer = Uint8Array.from(atob(note.iv), (c) => c.charCodeAt(0));
      const encryptedContentBuffer = Uint8Array.from(atob(note.content), (c) =>
        c.charCodeAt(0)
      );
      let finalKeyBuffer = keyBuffer;

      if (note.hasPassword) {
        if (!note.password) {
          throw new Error("æ­¤ç¬”è®°å—å¯†ç ä¿æŠ¤ï¼Œè¯·è¾“å…¥å¯†ç ã€‚");
        }
        const encoder = new TextEncoder();
        const passwordKey = await window.crypto.subtle.importKey(
          "raw",
          encoder.encode(note.password),
          { name: "PBKDF2" },
          false,
          ["deriveKey"]
        );
        const derivedPasswordKey = await window.crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt: ivBuffer,
            iterations: 100000,
            hash: "SHA-256",
          },
          passwordKey,
          { name: "AES-GCM", length: 256 },
          true,
          ["encrypt", "decrypt"]
        );
        try {
          finalKeyBuffer = await window.crypto.subtle.decrypt(
            { name: "AES-GCM", iv: ivBuffer },
            derivedPasswordKey,
            keyBuffer
          );
        } catch (err) {
          console.error("è§£å¯†å¯†é’¥å¤±è´¥:", err);
          throw new Error("å¯†ç é”™è¯¯æˆ–è§£å¯†å¯†é’¥å¤±è´¥ã€‚");
        }
      }

      const cryptoKey = await window.crypto.subtle.importKey(
        "raw",
        finalKeyBuffer,
        { name: "AES-GCM", length: 256 },
        true,
        ["decrypt"]
      );
      const decryptedContent = await window.crypto.subtle.decrypt(
        { name: "AES-GCM", iv: ivBuffer },
        cryptoKey,
        encryptedContentBuffer
      );
      const decoder = new TextDecoder();
      const decryptedText = decoder.decode(decryptedContent);
      return { content: decryptedText, cryptoKey, ivBuffer };
    }

    /**
     * æ¸²æŸ“å¯†ç è¾“å…¥è¡¨å•
     * @param {object} note - ç¬”è®°æ•°æ®å¯¹è±¡
     */
    function renderPasswordForm(note) {
      if (!passwordFormContainer) return;

      renderPasswordUI();
      bindPasswordFormEvents(note);
      passwordFormContainer.classList.remove("hidden");
    }

    function renderPasswordUI() {
      noteDisplayArea.innerHTML = `
        <p class="text-gray-500 text-center">ğŸ”’ æ­¤ç¬”è®°å—å¯†ç ä¿æŠ¤</p>
      `;

      passwordFormContainer.innerHTML = `
        <div class="max-w-md mx-auto bg-white border border-gray-100 rounded-3xl shadow-2xl p-6 sm:p-8 space-y-6 animate-fade-in">
          <div class="space-y-3 text-center">
            <div class="flex justify-center">
              <div class="bg-gradient-to-br from-sky-100 to-sky-200 text-sky-600 w-14 h-14 rounded-full flex items-center justify-center shadow-md">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 11c.828 0 1.5-.672 1.5-1.5S12.828 8 12 8s-1.5.672-1.5 1.5S11.172 11 12 11zM17 11V9a5 5 0 00-10 0v2m-1 0a2 2 0 00-2 2v5a2 2 0 002 2h12a2 2 0 002-2v-5a2 2 0 00-2-2h-1" />
                </svg>
              </div>
            </div>
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">è¾“å…¥å¯†ç ä»¥è§£é”</h2>
            <p class="text-sm text-gray-500">è¯¥ç¬”è®°å†…å®¹å·²åŠ å¯†ï¼Œè¯·è¾“å…¥æ­£ç¡®å¯†ç æŸ¥çœ‹ã€‚</p>
          </div>

          <form id="password-form" class="space-y-5">
            <input
              id="note-password-input"
              type="password"
              placeholder="è¯·è¾“å…¥å¯†ç "
              class="w-full px-5 py-3 text-base border border-gray-300 rounded-xl bg-gray-50 text-gray-700 placeholder-gray-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400 focus:bg-white transition duration-200"
              required
            />

            <div id="password-error-message"
              class="text-sm text-red-700 bg-red-100 rounded-md py-2 px-3 border border-red-300 hidden transition-opacity duration-200 opacity-0">
              å¯†ç é”™è¯¯ã€‚ä½ è¿˜æœ‰ <span id="attempts-left" class="font-semibold">${MAX_ATTEMPTS}</span> æ¬¡æœºä¼šã€‚
            </div>

            <button
              type="submit"
              class="w-full py-3 rounded-xl bg-sky-500 text-white font-semibold tracking-wide hover:bg-sky-600 active:scale-[0.97] transition duration-200"
            >
              ğŸ”“ è§£é”ç¬”è®°
            </button>
          </form>
        </div>
      `;
    }

    function bindPasswordFormEvents(note) {
      const passwordForm = document.getElementById("password-form");
      const passwordInput = document.getElementById("note-password-input");
      const passwordErrorMessage = document.getElementById(
        "password-error-message"
      );
      const attemptsLeftSpan = document.getElementById("attempts-left");

      if (!passwordForm || !passwordInput) return;

      passwordForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const password = passwordInput.value.trim();
        resetErrorState(passwordInput, passwordErrorMessage);

        try {
          await processNote(note, password);
        } catch (err) {
          passwordAttempts++;

          if (passwordAttempts >= MAX_ATTEMPTS) {
            await deleteNoteFromServer(noteId);
            showCustomAlert("æ‚¨å·²è¿ç»­è¾“é”™å¯†ç ä¸‰æ¬¡ï¼Œè¯¥ç¬”è®°å·²è¢«æ°¸ä¹…åˆ é™¤ã€‚");
            passwordAttempts = 0;
            return;
          }

          showPasswordError(
            passwordInput,
            passwordErrorMessage,
            attemptsLeftSpan
          );
        }
      });
    }

    function resetErrorState(input, errorBox) {
      input.classList.remove("border-red-500");
      input.placeholder = "è¯·è¾“å…¥å¯†ç ";
      errorBox.classList.add("hidden", "opacity-0");
    }

    function showPasswordError(input, errorBox, attemptsLeftSpan) {
      input.classList.add("border-red-500");
      input.value = "";
      input.focus();
      input.placeholder = "å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•";

      errorBox.classList.remove("hidden");

      // ç­‰å¾…ä¸‹ä¸€ä¸ªæ¸²æŸ“å¸§ï¼Œç¡®ä¿åŠ¨ç”»æ­£å¸¸è§¦å‘
      requestAnimationFrame(() => {
        errorBox.classList.remove("opacity-0");
      });

      if (attemptsLeftSpan) {
        attemptsLeftSpan.textContent = MAX_ATTEMPTS - passwordAttempts;
      }
    }

    /**
     * ç»Ÿä¸€å¤„ç†ç¬”è®°è§£å¯†å’Œæ¸²æŸ“çš„å‡½æ•°
     * @param {object} foundNote - ä»æœåŠ¡å™¨è·å–çš„ç¬”è®°æ•°æ®
     * @param {string|null} password - å¦‚æœæœ‰å¯†ç ï¼Œåˆ™ä¼ é€’å¯†ç 
     */
    async function processNote(foundNote, password = null) {
      const decryptionResult = await decryptNote({ ...foundNote, password });
      const decryptedContent = decryptionResult.content;
      let decryptedFiles = [];
      if (!isProduction && foundNote.files && foundNote.files.length > 0) {
        decryptedFiles = await decryptFiles(
          foundNote.files,
          decryptionResult.cryptoKey,
          decryptionResult.ivBuffer
        );
      }
      renderNoteContent(foundNote, decryptedContent, decryptedFiles);

      if (foundNote.deleteAfterReading) {
        window.addEventListener("beforeunload", () => {
          if (!deleteTriggered) {
            deleteNoteFromServer(foundNote.id);
            deleteTriggered = true;
          }
        });
      }
    }

    /**
     * åŠ è½½ç¬”è®°çš„å…¥å£å‡½æ•°
     */
    async function loadNote() {
      if (!noteId) {
        displayError("æ— æ•ˆçš„ç¬”è®°é“¾æ¥ã€‚");
        return;
      }
      try {
        const response = await fetch(`/api/note/${noteId}`);
        if (!response.ok) {
          const message =
            response.status === 404
              ? "âš ï¸ ç¬”è®°æœªæ‰¾åˆ°æˆ–å·²è¿‡æœŸ"
              : "ğŸš« åŠ è½½ç¬”è®°æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯";
          throw new Error(message);
        }
        const foundNote = await response.json();
        if (foundNote.hasPassword) {
          renderPasswordForm(foundNote);
        } else {
          await processNote(foundNote);
        }
      } catch (err) {
        console.error("åŠ è½½ç¬”è®°å¤±è´¥:", err);
        displayError(err.message);
      }
    }

    function formatExpiration(seconds) {
      const days = Math.floor(seconds / 86400);
      seconds %= 86400;
      const hours = Math.floor(seconds / 3600);
      seconds %= 3600;
      const minutes = Math.floor(seconds / 60);
      seconds %= 60;

      const parts = [];
      if (days) parts.push(`${days} day${days > 1 ? "s" : ""}`);
      if (hours) parts.push(`${hours} hr${hours > 1 ? "s" : ""}`);
      if (minutes) parts.push(`${minutes} min${minutes > 1 ? "s" : ""}`);
      if (seconds) parts.push(`${seconds} sec${seconds > 1 ? "s" : ""}`);

      return parts.length ? parts.join(" ") : "0 sec";
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadNote();
    });
  }
</script>
