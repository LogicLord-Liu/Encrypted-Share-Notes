---
import Layout from "../../layouts/Layout.astro";

// åœ¨æœåŠ¡å™¨ç«¯è·å–è·¯ç”±å‚æ•°
const { id } = Astro.params;
---

<Layout title="æŸ¥çœ‹ç¬”è®° - Enclosed">
  <main class="flex flex-col items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-2xl text-center">
      <h1 class="text-3xl font-bold mb-6 text-gray-800">ç¬”è®°å†…å®¹</h1>

      <div id="note-display-area">
        <p class="text-gray-600">æ­£åœ¨åŠ è½½ç¬”è®°...</p>
      </div>

      <div id="password-form-container" class="hidden"></div>

      <a href="/" class="mt-8 inline-block text-sky-600 hover:underline"
        >è¿”å›é¦–é¡µ</a
      >
    </div>
  </main>
</Layout>

<script is:inline>
  if (typeof window !== "undefined") {
    const url = new URL(window.location.href);
    const noteId = url.pathname.split("/").pop();
    const noteDisplayArea = document.getElementById("note-display-area");
    const passwordFormContainer = document.getElementById(
      "password-form-container"
    );
    const isProduction = window.location.hostname !== "localhost";

    let deleteTriggered = false;

    function displayError(message) {
      if (!noteDisplayArea) return;
      noteDisplayArea.innerHTML = `
Â  Â  Â  Â  <div class="text-red-500 font-medium text-center">åŠ è½½ç¬”è®°å¤±è´¥</div>
Â  Â  Â  Â  <p class="text-red-500 text-center mt-2">${message}</p>
Â  Â  Â  `;
    }

    function renderNoteContent(note, decryptedContent, decryptedFiles = []) {
      if (!noteDisplayArea) return;

      let fileListHtml = "";
      if (note.files && note.files.length > 0) {
        if (isProduction) {
          fileListHtml = `
Â  Â  Â  Â  Â  Â  <div class="mt-4">
Â  Â  Â  Â  Â  Â  Â  <p class="font-medium">é™„ä»¶:</p>
Â  Â  Â  Â  Â  Â  Â  <ul class="list-disc list-inside mt-1 mx-auto text-left w-fit">
Â  Â  Â  Â  Â  Â  Â  Â  ${note.files
            .map(
              (file) =>
                `<li><a href="/api/file/${note.id}/${file.fileId}" download="${file.name}" class="text-sky-600 hover:underline">${file.name}</a></li>`
            )
            .join("")}
Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  </div>`;
        } else {
          fileListHtml = `
Â  Â  Â  Â  Â  Â  <div class="mt-4">
Â  Â  Â  Â  Â  Â  Â  <p class="font-medium">é™„ä»¶:</p>
Â  Â  Â  Â  Â  Â  Â  <ul class="list-disc list-inside mt-1 mx-auto text-left w-fit">
Â  Â  Â  Â  Â  Â  Â  Â  ${decryptedFiles
            .map(
              (file) =>
                `<li><a href="${file.url}" download="${file.name}" class="text-sky-600 hover:underline">${file.name} (${(file.size / 1024).toFixed(1)} KB)</a></li>`
            )
            .join("")}
Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  </div>`;
        }
      }
      noteDisplayArea.innerHTML = `
Â  Â  Â  Â  <article class="prose lg:prose-lg mx-auto text-left break-all whitespace-pre-wrap">
          <p>${decryptedContent}</p>
        </article>

        <!-- ä¿¡æ¯å±•ç¤ºåŒº -->
        <div class="mt-10 pt-6 border-t border-gray-100 text-sm text-gray-600 space-y-3">

          <!-- æ—¶é—´ä¿¡æ¯åŒº -->
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 text-left">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M8 7V3M16 7V3M4 11h16M5 19h14a2 2 0 0 0 2-2v-6H3v6a2 2 0 0 0 2 2z"/>
              </svg>
              <span>åˆ›å»ºæ—¶é—´ï¼š${new Date(note.createdAt).toLocaleString()}</span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>è¿‡æœŸæ—¶é—´ï¼š${note.expiration}(s)</span>
            </div>
          </div>

          <!-- åˆ é™¤æç¤º -->
          ${
            note.deleteAfterReading
              ? `<p class="text-red-500 font-semibold text-center">
                  âš ï¸ æ­¤ç¬”è®°å°†åœ¨é¦–æ¬¡é˜…è¯»åè‡ªåŠ¨åˆ é™¤
                </p>`
              : ""
          }

          <!-- æ–‡ä»¶é™„ä»¶åŒºï¼ˆä¿æŒ fileListHtml ç»“æ„ï¼‰ -->
          ${fileListHtml}
Â  Â  Â  `;
      if (passwordFormContainer) {
        passwordFormContainer.innerHTML = "";
        passwordFormContainer.classList.add("hidden");
      }
    }

    async function decryptFiles(files, cryptoKey, ivBuffer) {
      const decryptedFiles = await Promise.all(
        files.map(async (file) => {
          try {
            const encryptedContentBuffer = Uint8Array.from(
              atob(file.data),
              (c) => c.charCodeAt(0)
            );
            const decryptedContent = await window.crypto.subtle.decrypt(
              { name: "AES-GCM", iv: ivBuffer },
              cryptoKey,
              encryptedContentBuffer
            );
            const blob = new Blob([decryptedContent], { type: file.type });
            const url = URL.createObjectURL(blob);
            return {
              name: file.name,
              size: file.size,
              type: file.type,
              url: url,
            };
          } catch (err) {
            console.error(`æ–‡ä»¶ ${file.name} è§£å¯†å¤±è´¥:`, err);
            return {
              name: `æ–‡ä»¶ ${file.name} (è§£å¯†å¤±è´¥)`,
              size: 0,
              type: "text/plain",
              url: "#",
            };
          }
        })
      );
      return decryptedFiles;
    }

    async function decryptNote(note) {
      if (!note.key || !note.iv || !note.content) {
        throw new Error("ç¬”è®°æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•è§£å¯†ã€‚");
      }
      const keyBase64 = note.key;
      const ivBase64 = note.iv;
      const encryptedContentBase64 = note.content;
      const notePassword = note.password || null;
      const keyBuffer = Uint8Array.from(atob(keyBase64), (c) =>
        c.charCodeAt(0)
      );
      const ivBuffer = Uint8Array.from(atob(ivBase64), (c) => c.charCodeAt(0));
      const encryptedContentBuffer = Uint8Array.from(
        atob(encryptedContentBase64),
        (c) => c.charCodeAt(0)
      );
      let finalKeyBuffer = keyBuffer;
      if (note.hasPassword) {
        if (!notePassword) {
          throw new Error("æ­¤ç¬”è®°å—å¯†ç ä¿æŠ¤ï¼Œè¯·è¾“å…¥å¯†ç ã€‚");
        }
        const encoder = new TextEncoder();
        const passwordKey = await window.crypto.subtle.importKey(
          "raw",
          encoder.encode(notePassword),
          { name: "PBKDF2" },
          false,
          ["deriveKey"]
        );
        const derivedPasswordKey = await window.crypto.subtle.deriveKey(
          {
            name: "PBKDF2",
            salt: ivBuffer,
            iterations: 100000,
            hash: "SHA-256",
          },
          passwordKey,
          { name: "AES-GCM", length: 256 },
          true,
          ["encrypt", "decrypt"]
        );
        try {
          finalKeyBuffer = await window.crypto.subtle.decrypt(
            { name: "AES-GCM", iv: ivBuffer },
            derivedPasswordKey,
            keyBuffer
          );
        } catch (err) {
          console.error("è§£å¯†å¯†é’¥å¤±è´¥:", err);
          throw new Error("å¯†ç é”™è¯¯æˆ–è§£å¯†å¯†é’¥å¤±è´¥ã€‚");
        }
      }
      const cryptoKey = await window.crypto.subtle.importKey(
        "raw",
        finalKeyBuffer,
        { name: "AES-GCM", length: 256 },
        true,
        ["decrypt"]
      );
      const decryptedContent = await window.crypto.subtle.decrypt(
        { name: "AES-GCM", iv: ivBuffer },
        cryptoKey,
        encryptedContentBuffer
      );
      const decoder = new TextDecoder();
      const decryptedText = decoder.decode(decryptedContent);
      return { content: decryptedText, cryptoKey, ivBuffer };
    }

    function renderPasswordForm(note) {
      if (!passwordFormContainer) return;
      noteDisplayArea.innerHTML =
        '<p class="text-gray-600">æ­¤ç¬”è®°å—å¯†ç ä¿æŠ¤ã€‚</p>';
      passwordFormContainer.innerHTML = `
Â  Â  Â  Â  <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-lg text-center border border-gray-100">
          <h2 class="text-3xl font-semibold mb-6 text-gray-800">ğŸ”’ è¾“å…¥å¯†ç ä»¥æŸ¥çœ‹å†…å®¹</h2>
          <form id="password-form" class="space-y-5">
            <input 
              id="note-password-input"
              type="password"
              placeholder="è¯·è¾“å…¥å¯†ç "
              class="w-full px-5 py-3 border border-gray-300 rounded-xl shadow-sm bg-gray-50 text-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:bg-white transition duration-200"
              required
            />
            <button 
              type="submit"
              class="w-full py-3 rounded-xl bg-sky-500 text-white font-medium tracking-wide hover:bg-sky-600 active:scale-[0.98] transition-all duration-200"
            >
              ğŸ”“ è§£é”ç¬”è®°
            </button>
          </form>
        </div>
Â  Â  Â  `;
      passwordFormContainer.classList.remove("hidden");
      const passwordForm = document.getElementById("password-form");
      const passwordInput = document.getElementById("note-password-input");
      if (passwordForm && passwordInput) {
        passwordForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const password = passwordInput.value;
          passwordInput.classList.remove("border-red-500");
          passwordInput.placeholder = "è¯·è¾“å…¥å¯†ç ";
          try {
            await processNote(note, password);
          } catch (err) {
            passwordInput.classList.add("border-red-500");
            passwordInput.placeholder = "å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•";
            passwordInput.value = "";
            console.error("è§£å¯†å¤±è´¥:", err);
          }
        });
      }
    } // æ–°å¢: ç»Ÿä¸€å¤„ç†ç¬”è®°è§£å¯†å’Œæ¸²æŸ“çš„å‡½æ•°

    async function processNote(foundNote, password = null) {
      const decryptionResult = await decryptNote({ ...foundNote, password });
      const decryptedContent = decryptionResult.content;
      let decryptedFiles = [];
      if (!isProduction && foundNote.files && foundNote.files.length > 0) {
        decryptedFiles = await decryptFiles(
          foundNote.files,
          decryptionResult.cryptoKey,
          decryptionResult.ivBuffer
        );
      }
      renderNoteContent(foundNote, decryptedContent, decryptedFiles); // â­ æ ¸å¿ƒæ”¹åŠ¨ï¼šå¦‚æœå¯ç”¨äº†é˜…åå³ç„šï¼Œåœ¨ç”¨æˆ·ç¦»å¼€é¡µé¢æ—¶åˆ é™¤ç¬”è®°

      if (foundNote.deleteAfterReading) {
        window.addEventListener("beforeunload", () => {
          // ä½¿ç”¨ navigator.sendBeacon æ¥å‘é€ DELETE è¯·æ±‚
          // å®ƒèƒ½ç¡®ä¿è¯·æ±‚åœ¨é¡µé¢å…³é—­åä¾ç„¶èƒ½æˆåŠŸå‘é€ï¼Œè€Œä¸ä¼šè¢«ä¸­æ–­
          if (!deleteTriggered) {
            const url = `/api/note/${foundNote.id}`;
            const beaconData = new FormData(); // ä½¿ç”¨ fetch å‘é€ DELETE è¯·æ±‚
            fetch(url, { method: "DELETE", keepalive: true })
              .then((response) => {
                console.log(`ç¬”è®° ${foundNote.id} å·²æˆåŠŸåˆ é™¤ã€‚`);
              })
              .catch((error) => {
                console.error(`åˆ é™¤ç¬”è®° ${foundNote.id} æ—¶å‡ºé”™:`, error);
              });
            deleteTriggered = true;
          }
        });
      }
    }
    async function loadNote() {
      if (!noteId) {
        displayError("æ— æ•ˆçš„ç¬”è®°é“¾æ¥ã€‚");
        return;
      }
      try {
        const response = await fetch(`/api/note/${noteId}`);
        console.log(`GET /api/note/${noteId} status: ${response.status}`);
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error("ç¬”è®°æœªæ‰¾åˆ°æˆ–å·²è¿‡æœŸã€‚");
          } else {
            throw new Error("åŠ è½½ç¬”è®°æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯ã€‚");
          }
        }
        const foundNote = await response.json();
        if (foundNote.hasPassword) {
          renderPasswordForm(foundNote);
        } else {
          await processNote(foundNote);
        }
      } catch (err) {
        console.error("åŠ è½½ç¬”è®°å¤±è´¥:", err);
        displayError(err.message);
      }
    }
    document.addEventListener("DOMContentLoaded", () => {
      loadNote();
    });
  }
</script>
